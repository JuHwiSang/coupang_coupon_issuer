# ADR 009: 엑셀 6컬럼 구조 (할인금액/비율 분리)

**상태**: 승인됨
**날짜**: 2024-12-17
**결정자**: 프로젝트 오너
**대체**: [ADR 001](001-excel-structure.md)

## 컨텍스트

ADR 001에서 정의한 5컬럼 구조에서 '발급개수' 컬럼이 **두 가지 목적**으로 사용되고 있었습니다:
1. 할인 금액/비율 (discount value)
2. 다운로드쿠폰의 일일 최대 발급개수 (maximumPerDaily)

이는 다음과 같은 문제를 발생시킵니다:
- **의미적 혼란**: '발급개수'라는 이름은 "발급할 쿠폰의 개수"를 의미하지만, 실제로는 할인율(10%)이나 할인금액(1000원)을 입력받음
- **코드 복잡도**: `issue_count` 변수가 discount와 quantity를 동시에 표현
- **API 매핑 오류**: 다운로드쿠폰에서 `maximumPerDaily`에 할인 금액을 넣는 버그 발생
- **사용자 혼란**: 사용자가 '발급개수' 컬럼에 할인 정보를 입력하는 것이 직관적이지 않음

## 결정사항

### 엑셀 파일 구조 변경: 5컬럼 → 6컬럼

| 컬럼 | 이름 | 목적 | 예시 | 비고 |
|------|------|------|------|------|
| A | 쿠폰이름 | 쿠폰 명칭 | "신규회원 할인" | - |
| B | 쿠폰타입 | 즉시할인 또는 다운로드쿠폰 | "즉시할인" | - |
| C | 쿠폰유효기간 | 발급일로부터 며칠간 유효 | "2" (2일) | - |
| D | 할인방식 | RATE/FIXED_WITH_QUANTITY/PRICE | "RATE" | - |
| **E** | **할인금액/비율** | **할인 금액 또는 비율** | **"10"** | **할인방식에 따라 의미 다름** |
| **F** | **발급개수** | **쿠폰 발급 개수** | **"100"** | **다운로드쿠폰만 사용** |

### 컬럼별 상세 설명

#### Column E: 할인금액/비율 (필수)

모든 쿠폰 타입에서 **필수** 입력:

- **RATE (정률할인)**: 1~99 사이의 정수 (퍼센트)
  - 예: `10` = 10% 할인
  - 검증: `1 <= value <= 99`

- **PRICE (정액할인)**: 10원 이상, 10원 단위 (원화)
  - 예: `1000` = 1000원 할인
  - 검증: `value >= 10 and value % 10 == 0`

- **FIXED_WITH_QUANTITY (수량할인)**: 할인방식에 따라 다름
  - "n개 구매 시 n번 할인" 의미
  - RATE 기반: 1~99 (퍼센트)
  - PRICE 기반: ≥10, 10원 단위 (원화)
  - 검증: `value >= 1`

#### Column F: 발급개수 (선택적)

쿠폰 타입에 따라 동작이 다름:

- **즉시할인 (Instant Discount)**:
  - **무시됨** (API에서 사용하지 않음)
  - 비어있어도 OK, 값이 있어도 OK
  - 입력 값은 검증하지 않음

- **다운로드쿠폰 (Download Coupon)**:
  - **선택적** (비어있으면 기본값 사용)
  - 비어있는 경우: `COUPON_DEFAULT_ISSUE_COUNT = 1` 사용
  - 값이 있는 경우: ≥1 검증
  - API의 `maximumPerDaily` 파라미터로 사용됨

### 파일 위치

- **입력 파일**: `/etc/coupang_coupon_issuer/coupons.xlsx`
- **설정 파일**: `src/coupang_coupon_issuer/config.py`
  - `COUPON_DEFAULT_ISSUE_COUNT = 1` 추가

### 고정값 (config.py)

다음 값들은 여전히 고정:

- **예산**: `-1` (무제한)
- **최소 구매금액**: `0` (제한없음)
- **최대 할인금액**: `10000` (기본값)
- **유효 시작일**: 실행일 0시 0분 0초
- **contract_id**: `-1` (고정값)
- **user_id, vendor_id**: 설치 시 수집하여 credentials.json에 저장
- **발급개수 기본값**: `1` (다운로드쿠폰, Column F가 비어있을 때)

## 근거

### 1. 의미적 명확성 (Semantic Clarity)

**Before (5컬럼):**
```
쿠폰이름 | 쿠폰타입 | 쿠폰유효기간 | 할인방식 | 발급개수
신규할인 | 즉시할인 | 2 | RATE | 10        <- "발급개수 10개"? 아니면 "10% 할인"?
```

**After (6컬럼):**
```
쿠폰이름 | 쿠폰타입 | 쿠폰유효기간 | 할인방식 | 할인금액/비율 | 발급개수
신규할인 | 즉시할인 | 2 | RATE | 10 | (empty)  <- 명확: "10% 할인, 발급개수 없음"
```

### 2. API 매핑 정확성 (API Mapping Correctness)

**Before (버그 있음):**
```python
# issuer.py line 168
policy = {
    "discount": issue_count,          # 할인 금액 (예: 10)
    "maximumPerDaily": issue_count    # BUG: 똑같은 값 사용! (일일 발급개수 10개?)
}
```

**After (올바름):**
```python
policy = {
    "discount": coupon['discount'],         # Column E: 할인 금액/비율 (예: 10%)
    "maximumPerDaily": coupon['issue_count']  # Column F: 발급개수 (예: 100개)
}
```

### 3. 사용자 경험 개선 (User Experience)

- 컬럼 이름이 실제 입력값과 일치
- '할인금액/비율' 컬럼에 할인 정보 입력 → 직관적
- '발급개수' 컬럼에 발급 개수 입력 → 직관적
- 즉시할인 사용 시 '발급개수' 비워두면 됨 → 간단

### 4. 코드 유지보수성 (Code Maintainability)

- 변수명과 실제 의미가 일치: `discount`, `issue_count`
- 타입별 분기 로직 단순화
- 검증 로직 분리 가능

## 예시

### 즉시할인 (Instant Discount)

| 쿠폰이름 | 쿠폰타입 | 쿠폰유효기간 | 할인방식 | 할인금액/비율 | 발급개수 |
|----------|----------|--------------|----------|---------------|----------|
| 신규회원10%할인 | 즉시할인 | 30 | RATE | 10 | (비어있음) |
| VIP정액할인 | 즉시할인 | 7 | PRICE | 5000 | 999 |
| 수량할인이벤트 | 즉시할인 | 15 | FIXED_WITH_QUANTITY | 1000 | |

- Column F는 무시됨 (비어있어도 OK, 값이 있어도 OK)

### 다운로드쿠폰 (Download Coupon)

| 쿠폰이름 | 쿠폰타입 | 쿠폰유효기간 | 할인방식 | 할인금액/비율 | 발급개수 |
|----------|----------|--------------|----------|---------------|----------|
| 다운로드10%쿠폰 | 다운로드쿠폰 | 30 | RATE | 10 | 500 |
| 다운로드정액쿠폰 | 다운로드쿠폰 | 7 | PRICE | 2000 | 1000 |
| 수량다운로드 | 다운로드쿠폰 | 15 | FIXED_WITH_QUANTITY | 500 | |

- Column F가 비어있으면 기본값 1 사용

## 대안

### 대안 1: 5컬럼 유지 (거부됨)

- 현재 구조 유지
- **문제**: 의미적 혼란, API 매핑 버그, 코드 복잡도
- **거부 이유**: 근본적인 설계 문제 해결 불가

### 대안 2: 7컬럼 구조 (거부됨)

'할인율', '할인금액', '발급개수' 3개로 분리

| ... | 할인방식 | 할인율 | 할인금액 | 발급개수 |
|-----|----------|--------|----------|----------|

- **장점**: 더 명확한 분리
- **단점**: 사용자가 어느 컬럼을 채워야 할지 혼란, 불필요한 복잡도
- **거부 이유**: 과도한 복잡성, '할인방식'으로 충분히 구분 가능

### 대안 3: 발급개수 필수화 (거부됨)

모든 쿠폰 타입에서 '발급개수' 필수 입력

- **문제**: 즉시할인에서는 사용하지 않는데 입력 강제
- **거부 이유**: 사용자 경험 저하

## 영향

### 코드 변경 (Source Code)

1. **config.py**: `COUPON_DEFAULT_ISSUE_COUNT = 1` 추가
2. **issuer.py**:
   - `_fetch_coupons_from_excel()`: 6컬럼 파싱 로직
   - `_issue_one()`: `coupon['discount']`, `coupon['issue_count']` 분리
3. **main.py**: `cmd_apply()` 검증 로직 업데이트

### 테스트 변경 (Tests)

1. **conftest.py**: Fixture를 6컬럼으로 수정
2. **test_issuer.py**: 23개 테스트 업데이트
3. **test_cli.py**: 20개 테스트 업데이트
4. **tests/fixtures/*.xlsx**: 4개 엑셀 파일 업데이트

### 문서 변경 (Documentation)

1. **ADR 001**: Superseded by ADR 009
2. **DEV_LOG.md**: 컬럼 분리 결정 기록
3. **CLAUDE.md**: 예시 업데이트

### 마이그레이션 (Migration)

- **불필요**: 이 프로젝트는 아직 배포되지 않음
- 기존 사용자 없음

## 참조

- [ADR 001: 엑셀 입력 구조](001-excel-structure.md) (Superseded)
- [ADR 002: 입력 정규화](002-input-normalization.md) (여전히 유효)
- [ADR 003: API 인증](003-api-authentication.md)
- [ADR 007: 쿠폰 발급 워크플로우](007-coupon-issuance-workflow.md)
