# ADR 021: Excel 9컬럼 구조 - 할인금액 설정 추가

**상태**: 승인됨  
**날짜**: 2025-12-26  
**결정자**: 프로젝트 오너  
**업데이트**: [ADR 015](015-option-id-column.md) (7컬럼 → 9컬럼)

## 컨텍스트

ADR 015에서 정의한 7컬럼 구조에서는 **최대할인금액**과 **최소구매금액**이 하드코딩되어 있어 사용자가 쿠폰별로 설정할 수 없었습니다:

- **최대할인금액**: `config.py`의 `COUPON_MAX_DISCOUNT = 100000` 상수로 고정 (10만원)
- **최소구매금액**: `issuer.py`의 `minimumPrice: 0` 하드코딩 (다운로드쿠폰 전용)

이로 인해 모든 쿠폰이 동일한 최대할인금액과 최소구매금액을 사용하게 되어 유연성이 부족했습니다.

## 결정사항

### 1. Excel 파일 구조 변경: 7컬럼 → 9컬럼

| 컬럼 | 이름 | 목적 | 예시 | 비고 |
|------|------|------|------|------|
| A | 쿠폰이름 | 쿠폰 명칭 | "신규회원 할인" | - |
| B | 쿠폰타입 | 즉시할인 또는 다운로드쿠폰 | "즉시할인" | - |
| C | 쿠폰유효기간 | 발급일로부터 며칠간 유효 | "2" (2일) | - |
| D | 할인방식 | 정률할인/수량별 정액할인/정액할인 | "정률할인" | 한글 입력 |
| E | 할인금액/비율 | 할인 금액 또는 비율 | "10" | 할인방식에 따라 의미 다름 |
| **F** | **최소구매금액** | **쿠폰 사용 최소 구매 조건** | **"10000"** | **다운로드쿠폰 전용, 기본값 10** |
| **G** | **최대할인금액** | **정률할인 시 최대 할인 금액** | **"5000"** | **필수, 모든 쿠폰** |
| H | 발급개수 | 쿠폰 발급 개수 | "100" | 다운로드쿠폰만 사용 |
| I | 옵션ID | 쿠폰을 적용할 상품 옵션ID | "3226138951, 3226138847" | 쉼표로 구분 |

### 2. Column F: 최소구매금액 (다운로드쿠폰 전용, 선택적)

**의미**: 이 쿠폰을 사용하기 위해 필요한 최소 구매 금액

**형식**:
- 숫자 (원 단위)
- 예: `10000` (1만원 이상 구매 시 사용 가능)
- 비어있으면 기본값 1원 사용

**검증**:
- 1원 이상의 양의 정수 (10원 단위 권장)
- 다운로드쿠폰만 사용 (즉시할인쿠폰은 무시)
- **Coupang API 제약**: 최소 10원 이상 (기본값 10원 사용)

**파싱 로직**:
```python
# 다운로드쿠폰인 경우
if coupon_type == '다운로드쿠폰':
    if min_purchase_raw and min_purchase_raw != 'None':
        min_purchase_price = int(float(min_purchase_digits)) if min_purchase_digits else 1
        if min_purchase_price < 1:
            raise ValueError("최소구매금액은 1원 이상이어야 합니다")
    else:
        min_purchase_price = 10  # 기본값 (API 최소값: 10원)
```

### 3. Column G: 최대할인금액 (필수)

**의미**: 정률할인 시 적용할 수 있는 최대 할인 금액

**형식**:
- 숫자 (원 단위)
- 예: `5000` (10% 할인이지만 최대 5000원까지만)
- 필수 입력

**검증**:
- 1원 이상의 양의 정수
- 비어있으면 에러

**파싱 로직**:
```python
max_discount_price = int(float(max_discount_digits)) if max_discount_digits else 0
if max_discount_price <= 0:
    raise ValueError("최대할인금액은 0보다 커야 합니다")
```

### 4. 컬럼 순서 논리

컬럼 순서는 다음과 같은 논리로 구성됩니다:

1. **쿠폰 기본 정보** (A-E): 이름, 타입, 유효기간, 할인방식, 할인값
2. **할인 조건** (F-G): 최소구매금액, 최대할인금액
3. **발급 설정** (H): 발급개수
4. **적용 대상** (I): 옵션ID

이 순서는 사용자가 쿠폰을 정의할 때 자연스러운 사고 흐름을 따릅니다.

### 5. 코드 변경사항

#### config.py
```python
# 기존 상수 제거
# COUPON_MAX_DISCOUNT = 100000  # 제거됨 (ADR 021)

# 새로운 기본값 상수 추가
COUPON_MIN_PURCHASE_PRICE = 10  # 최소 구매금액 기본값 (API 요구사항)
```

#### reader.py
```python
# 9컬럼 파싱
coupon = {
    'name': coupon_name,
    'type': coupon_type,
    'validity_days': validity_days,
    'discount_type': discount_type,
    'discount': discount,
    'min_purchase_price': min_purchase_price,  # 신규
    'max_discount_price': max_discount_price,  # 신규
    'issue_count': issue_count,
    'vendor_items': vendor_items,
}
```

#### issuer.py
```python
# Excel에서 값 사용 (기본값 10)
max_discount_price = coupon.get('max_discount_price')
min_purchase_price = coupon.get('min_purchase_price')  # 다운로드쿠폰만

# API 호출 시 전달
self.api_client.create_instant_coupon(
    max_discount_price=max_discount_price,  # Excel 값
    ...
)

policy = {
    "minimumPrice": min_purchase_price,  # Excel 값 (기본값 10)
    "maximumDiscountPrice": max_discount_price,  # Excel 값
    ...
}
```

## 근거

### 1. 쿠폰별 유연성

쿠폰마다 다른 최대할인금액과 최소구매금액을 설정할 수 있어야 합니다:
- VIP 쿠폰: 20% 할인, 최대 50,000원
- 일반 쿠폰: 10% 할인, 최대 5,000원
- 고가 상품 쿠폰: 5% 할인, 10만원 이상 구매 시

### 2. 직관적인 컬럼 이름

- **최소구매금액**: 쇼핑몰에서 흔히 사용하는 용어 ("10,000원 이상 구매 시")
- **최대할인금액**: 명확한 의미 ("최대 5,000원 할인")

### 3. 기본값 정책

- **최소구매금액**: 기본값 10원 (API 최소 요구사항)
  - 사용자가 비워두면 실질적으로 제한 없음 (최소 단위 10원)
  - 필요 시 명시적으로 입력
- **최대할인금액**: 필수 입력
  - 정률할인에서 중요한 값
  - 비즈니스 로직상 반드시 설정 필요

### 4. 다운로드쿠폰 전용 컬럼

최소구매금액은 다운로드쿠폰에서만 사용됩니다:
- 즉시할인쿠폰: API에서 지원하지 않음
- 다운로드쿠폰: `minimumPrice` 필드로 전달

## 예시

### 즉시할인 쿠폰

| 쿠폰이름 | 쿠폰타입 | 쿠폰유효기간 | 할인방식 | 할인금액/비율 | 최소구매금액 | 최대할인금액 | 발급개수 | 옵션ID |
|----------|----------|--------------|----------|---------------|--------------|--------------|----------|--------|
| VIP 20% 할인 | 즉시할인 | 30 | 정률할인 | 20 | | 50000 | | 1234567890 |
| 일반 10% 할인 | 즉시할인 | 7 | 정률할인 | 10 | | 5000 | | 9876543210 |

### 다운로드 쿠폰

| 쿠폰이름 | 쿠폰타입 | 쿠폰유효기간 | 할인방식 | 할인금액/비율 | 최소구매금액 | 최대할인금액 | 발급개수 | 옵션ID |
|----------|----------|--------------|----------|---------------|--------------|--------------|----------|--------|
| 고가상품 5% | 다운로드쿠폰 | 30 | 정률할인 | 5 | 100000 | 10000 | 100 | 3226138951 |
| 신규회원 3000원 | 다운로드쿠폰 | 15 | 정액할인 | 3000 | 10000 | 3000 | 500 | 4802314648 |

## 대안

### 대안 1: 최대할인금액도 선택적으로 (거부됨)

기본값을 사용하도록 허용 (예: 100,000원)

- **장점**: 사용자 입력 간소화
- **단점**: 비즈니스 로직상 중요한 값이므로 명시적 입력 필요
- **거부 이유**: 쿠폰마다 다른 값을 설정해야 하므로 필수 입력이 적절

### 대안 2: 최소구매금액을 1원 기본값으로 (거부됨)

기본값을 1원으로 설정

- **장점**: "제한 없음"의 의미가 더 명확
- **단점**: API에서 10원 단위를 요구하므로 에러 발생
- **거부 이유**: API 요구사항(10원 단위)을 충족하기 위해 10원을 기본값으로 함

### 대안 3: 컬럼 순서를 발급개수 → 최소구매금액 → 최대할인금액 → 옵션ID로 (거부됨)

기존 7컬럼 순서 유지

- **장점**: 기존 구조와 유사
- **단점**: 논리적 흐름이 부자연스러움
- **거부 이유**: 할인 조건을 먼저 설정하고, 발급 설정을 나중에 하는 것이 더 직관적

## 영향

### 코드 변경

1. **config.py**: `COUPON_MAX_DISCOUNT` 제거, `COUPON_MIN_PURCHASE_PRICE` 추가
2. **reader.py**: 9컬럼 파싱 로직, 검증 추가
3. **issuer.py**: 하드코딩 제거, Excel 값 사용

### 테스트 변경

1. **test_reader.py**: 9컬럼 테스트 추가
2. **test_issuer.py**: 새 파라미터 반영
3. **tests/fixtures/*.xlsx**: 9컬럼으로 업데이트

### 문서 변경

1. **ADR 004**: `COUPON_MAX_DISCOUNT` 제거 기록
2. **ADR 015**: "Updated by ADR 021" 표시
3. **CLAUDE.md**: 9컬럼 구조 반영
4. **DEV_LOG.md**: 변경사항 기록

### 예제 파일 변경

1. **scripts/generate_example.py**: 9컬럼 생성, 헤더 주석, 검증 규칙
2. **examples/*.xlsx**: 재생성

## 참조

- [ADR 004: 고정 설정값](004-fixed-configuration-values.md) (Updated)
- [ADR 015: 옵션ID 컬럼 추가](015-option-id-column.md) (Updated)
- [ADR 017: 쿠폰 타입별 할인 검증 규칙 분리](017-coupon-type-specific-validation.md)
- [ADR 018: 할인방식 한글 입력 지원](018-korean-discount-type-names.md)

## 변경 이력

### 2025-12-26 - 최소구매금액 기본값 수정
- 다운로드쿠폰의 `minimumPrice` 기본값을 1원에서 10원으로 수정 (API 요구사항 준수)
- 관련 검증 및 파싱 로직 설명 업데이트
