# ADR 023: 다운로드쿠폰 파기 및 재발급 워크플로우

**Status**: Accepted  
**Date**: 2026-01-01  
**Deciders**: 개발팀, 클라이언트

## Context

클라이언트로부터 다운로드쿠폰에 대한 파기 및 재발급 기능 요청이 있었습니다. 매일 자정에 쿠폰을 발급하는 현재 시스템에서, 다운로드쿠폰의 경우 이전에 발급된 쿠폰을 파기하고 새로운 쿠폰을 발급해야 하는 요구사항이 발생했습니다.

### 요구사항

1. **다운로드쿠폰만 대상**: 즉시할인쿠폰은 파기 대상이 아님 (클라이언트 명시적 요청)
2. **파기 후 재발급**: 기존 쿠폰 파기 → 새 쿠폰 발급 → 쿠폰 ID 기록
3. **하위 호환성**: 기존 배포 인스턴스가 존재하므로 파일 없어도 정상 동작 필요

### 고려사항

- **프로젝트 크기**: 작은 프로젝트이지만, 이 결정은 프로젝트 크기 대비 영향력이 큼
- **파일 형식**: 구조화된 데이터 저장 필요 (쿠폰 이름, ID, 발급 시각)
- **확장성**: 향후 추가 정보 기록 가능성
- **골드플레이팅 방지**: 요청되지 않은 즉시할인쿠폰 파기 기능은 구현하지 않음

## Decision

### 1. JSON 파일 형식 사용

`download_coupons.json` 파일로 다운로드쿠폰 ID를 기록합니다.

**파일 구조**:
```json
{
  "last_updated": "2026-01-01 00:00:00",
  "coupons": [
    {
      "name": "신규회원 할인",
      "coupon_id": 12345,
      "issued_at": "2026-01-01 00:00:00"
    },
    {
      "name": "VIP 할인",
      "coupon_id": 67890,
      "issued_at": "2026-01-01 00:00:00"
    }
  ]
}
```

**선택 이유**:
- 구조화된 데이터 저장 가능
- 확장성 좋음 (향후 필드 추가 용이)
- 파싱 및 검증 용이
- 사람이 읽기 쉬움 (디버깅 편의성)

### 2. 워크플로우 설계

**발급 프로세스**:
```
1. 엑셀 파일 읽기
2. 이전 다운로드쿠폰 파기 (새로운 단계)
   - download_coupons.json 읽기
   - 각 쿠폰 ID에 대해 파기 API 호출
   - 기록 파일 초기화
3. 새 쿠폰 발급
   - 즉시할인쿠폰: 기존 로직 유지
   - 다운로드쿠폰: 발급 후 ID 기록
4. 결과 출력
```

### 3. 하위 호환성 전략

기존 배포 인스턴스와의 호환성을 위해 **warning-only** 접근 방식 사용:

- `download_coupons.json` 파일 없음 → WARNING 출력 후 계속 진행
- 파일 파싱 실패 → WARNING 출력 후 계속 진행
- 파기 API 실패 → WARNING 출력 후 계속 진행

**오류가 아닌 경고로 처리하여 기존 시스템 정상 동작 보장**

### 4. 즉시할인쿠폰 제외

클라이언트가 다운로드쿠폰에 대해서만 파기 필요성을 요청했으므로, 즉시할인쿠폰은 파기 대상에서 제외합니다.

**이유**:
- 클라이언트 요청 범위 준수
- 골드플레이팅 방지
- 코드 복잡도 최소화

## Consequences

### Positive

- ✅ **구조화된 기록**: JSON 형식으로 쿠폰 정보 체계적 관리
- ✅ **확장성**: 향후 추가 정보 기록 용이
- ✅ **하위 호환성**: 기존 배포 인스턴스 영향 없음
- ✅ **명확한 워크플로우**: 파기 → 발급 → 기록 순서 명확
- ✅ **디버깅 편의성**: JSON 파일로 발급 이력 추적 가능

### Negative

- ⚠️ **파일 관리 필요**: 새로운 파일 추가로 관리 포인트 증가
- ⚠️ **쿠폰 타입별 차이**: 즉시할인쿠폰과 다운로드쿠폰의 워크플로우 차이 발생
- ⚠️ **동시성 이슈 가능성**: 여러 인스턴스 동시 실행 시 파일 충돌 가능 (현재는 단일 인스턴스 가정)

### Neutral

- 📝 **API 레이어 확장**: `expire_download_coupons()` 메서드 추가
- 📝 **issuer.py 복잡도 증가**: 기록 관리 메서드 4개 추가
- 📝 **테스트 증가**: 유닛 테스트 약 13개, 통합 테스트 2개 추가

## Implementation

### 변경 파일

**소스코드** (3개):
- `coupang_api.py`: `expire_download_coupons()` 메서드 추가
- `config.py`: `get_download_coupons_file()` 경로 함수 추가
- `issuer.py`: 파기 및 기록 관리 로직 추가

**문서** (4개):
- `docs/coupang/download-coupon-expire-api.md`: API 규격 문서
- `docs/adr/023-download-coupon-expiration.md`: 본 ADR
- `CLAUDE.md`: 배포 후 구조 업데이트
- `DEV_LOG.md`: 변경 이력 기록

**테스트** (4개):
- `test_coupang_api.py`: 파기 API 테스트 3개
- `test_config.py`: 경로 함수 테스트 2개
- `test_issuer.py`: 기록 관리 및 파기 테스트 8개
- `test_issue.py`: 통합 테스트 2개

### 배포 후 디렉토리 구조

```
~/my-coupons/
├── config.json                  # API 키 + UUID (600 권한)
├── coupons.xlsx                 # 쿠폰 정의 (사용자 배치)
├── download_coupons.json        # 다운로드쿠폰 ID 기록 (자동 생성) ← 신규
└── issuer.log                   # 실행 로그 (자동 생성)
```

## Alternatives Considered

### 1. 단순 텍스트 파일

**형식**: 쿠폰 ID만 라인별로 저장
```
12345
67890
```

**장점**: 간단함, 파싱 용이  
**단점**: 확장성 낮음, 쿠폰 이름 등 추가 정보 저장 불가  
**결정**: ❌ 확장성 부족으로 기각

### 2. SQLite 데이터베이스

**형식**: 로컬 SQLite DB에 쿠폰 정보 저장

**장점**: 쿼리 가능, 트랜잭션 지원  
**단점**: 의존성 추가, 과도한 복잡도  
**결정**: ❌ 프로젝트 크기 대비 과도한 복잡도로 기각

### 3. issuer.log에 통합

**형식**: 로그 파일에 쿠폰 ID 기록

**장점**: 파일 개수 증가 없음  
**단점**: 파싱 복잡, 로그와 데이터 혼재  
**결정**: ❌ 관심사 분리 원칙 위배로 기각

### 4. 즉시할인쿠폰도 파기 대상 포함

**범위**: 모든 쿠폰 타입에 대해 파기 기능 구현

**장점**: 기능 통일성, 코드 일관성  
**단점**: 골드플레이팅, 클라이언트 요청 범위 초과  
**결정**: ❌ 클라이언트 요청 범위 준수 및 골드플레이팅 방지로 기각

## References

- [다운로드쿠폰 파기 API 문서](../coupang/download-coupon-expire-api.md)
- [ADR 007: 쿠폰 발급 워크플로우](007-coupon-issuance-workflow.md)
- [ADR 014: 스크립트 기반 배포](014-script-based-deployment.md)
- [ADR 021: Excel 9컬럼 구조](021-excel-9-column-structure.md)

## Notes

- 첫 실행 또는 업그레이드 후에는 `download_coupons.json` 파일이 없으므로 WARNING만 출력하고 정상 진행
- 파기 API 실패 시에도 새 쿠폰 발급은 계속 진행 (하위 호환성)
- 동시성 제어는 현재 구현하지 않음 (단일 인스턴스 가정)
