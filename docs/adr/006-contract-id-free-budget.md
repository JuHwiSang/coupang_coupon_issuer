# ADR 006: contract_id 자유계약 사용 (-1)

**상태**: 승인됨
**날짜**: 2024-12-16
**결정자**: 프로젝트 오너

## 컨텍스트

Coupang API에서 쿠폰을 발급할 때 `contractId` 파라미터가 필수입니다. 이 값은 **어떤 예산(계약)에서 쿠폰 비용을 차감할지**를 결정합니다.

### contract_id란?

- **계약서 ID**로, 쿠폰 발급 시 사용할 예산을 지정하는 값
- 각 계약마다 할당된 예산이 있으며, 쿠폰 발급 시 해당 예산에서 비용 차감
- Coupang API를 통해 현재 사용 가능한 계약 목록을 조회할 수 있음

### 가능한 선택지

1. **특정 계약 ID 사용** (예: `10`, `15`, `20`)
   - 별도 API로 계약 목록 조회
   - 알고리즘에 따라 적절한 계약 선택
   - 예산 소진 시 쿠폰 발급 실패 가능

2. **`-1` (자유계약) 사용**
   - 특정 계약에 종속되지 않음
   - 무제한 예산으로 취급
   - 항상 발급 가능

## 결정사항

**`contract_id = -1` (자유계약, 무제한 예산)을 고정값으로 사용**

```python
# config.py
COUPON_CONTRACT_ID = -1  # 계약서 ID 고정값
```

- 설치 시 사용자에게 contract_id를 물어보지 않음
- config.py에 고정 상수로 정의
- issuer.py에서 직접 참조하여 사용

## 근거

### 1. 단순성
- 별도 API 호출 없이 즉시 쿠폰 발급 가능
- 계약 목록 조회, 선택 로직 불필요
- 코드 복잡도 최소화

### 2. 예측 가능성
- 예산 소진으로 인한 발급 실패 없음
- 매일 0시 자동 실행 시 안정적으로 동작
- 예외 상황 최소화

### 3. 투명성
- 사용자에게 "자유예산에서 쿠폰이 발급된다"는 사실을 명확히 설명 가능
- 어떤 계약에서 비용이 차감되는지 혼란 없음
- 향후 비용 추적 시 단일 출처로 관리 용이

### 4. 유지보수성
- 계약 만료, 변경 등에 영향받지 않음
- 설정 변경 없이 지속적으로 동작
- 관리 포인트 감소

### 5. 자동화 친화적
- 매일 자동 실행되는 서비스에 적합
- 사람 개입 없이 안정적으로 동작
- 실패 확률 최소화

## 대안

### 대안 1: 설치 시 사용자에게 contract_id 입력받기
- **장점**: 특정 계약 예산 사용 가능
- **단점**:
  - 사용자가 올바른 값을 입력해야 함
  - 계약 만료 시 쿠폰 발급 실패
  - 예산 소진 시 추가 관리 필요
- **결정**: 거부됨 (사용자 경험 나쁨, 관리 복잡도 증가)

### 대안 2: API로 계약 목록 조회 후 자동 선택
- **장점**:
  - 사용자 입력 불필요
  - 유효한 계약 자동 선택
- **단점**:
  - 추가 API 호출 필요 (복잡도 증가)
  - 선택 알고리즘 필요 (어떤 계약을 선택할지)
  - 예산 소진 시 처리 로직 필요
- **결정**: 거부됨 (불필요한 복잡도)

### 대안 3: 환경 변수로 설정
- **장점**:
  - 필요 시 변경 가능
- **단점**:
  - 대부분의 경우 `-1`을 사용하므로 불필요
  - 설정 파일 관리 포인트 증가
- **결정**: 거부됨 (과도한 유연성)

## 영향

### 긍정적 영향
- config.py에 간단히 상수로 정의
- 설치 프로세스 단순화 (4개 파라미터만 수집)
- 쿠폰 발급 안정성 향상
- 유지보수 비용 감소

### 부정적 영향
- 특정 계약 예산을 사용하고 싶은 경우 코드 수정 필요
  - 현재 요구사항에는 해당하지 않음
  - 향후 필요 시 새 ADR 작성하여 변경 가능

## 구현

### config.py
```python
COUPON_CONTRACT_ID = -1  # 계약서 ID 고정값 (자유계약, 무제한 예산)
```

### issuer.py
```python
from .config import COUPON_CONTRACT_ID

# 즉시할인쿠폰 생성 시
api_result = self.api_client.create_instant_coupon(
    vendor_id=self.vendor_id,
    contract_id=COUPON_CONTRACT_ID,  # -1 사용
    ...
)

# 다운로드쿠폰 생성 시
api_result = self.api_client.create_download_coupon(
    contract_id=COUPON_CONTRACT_ID,  # -1 사용
    ...
)
```

## 참고 문서

- [Coupang API: 파라미터 상세 설명](../coupang/parameters-explained.md)
- [ADR 004: 고정 설정값](004-fixed-configuration-values.md)
